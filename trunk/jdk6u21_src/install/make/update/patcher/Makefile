#
# Copyright (c) 2006, Oracle and/or its affiliates. All rights reserved.
# ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
#

#
# @(#)Makefile	1.12 10/03/23
#

#
# Makefile for building patch installer for the JDK and the JRE. See
# also included files.
#

#
# Most frequently used targets:
#
#    all            -- build the patch installer
#    jre	    -- build the patch installer for JRE
#    clobber        -- clobber the files generated by this Makefile 

INSTALL_BUILDDIR=../..
include $(INSTALL_BUILDDIR)/common/Defs.gmk

all:: 
	@$(ECHO) $(ARCH) "Patcher Build started:  " $(FULL_VERSION)

# sigh. this is a real hack - JRE/JDK packaging and the Plugin
# require absolute paths - In order to get these, OUTPUTDIR must
# exist now. This forces the creation. This is done here so that
# it only happens once.
dummy := $(shell $(MKDIR) -p $(OUTPUTDIR))

all build::
	@for i in `$(CD) $(ALT_BASE_IMAGE_DIR) ; $(LS) -d jre*` ; do \
	    $(ECHO) ">>>Recursively making "$$i" Patcher for JRE "$@" @ `$(DATE)` ..."; \
	    $(CD) jre; SMALLER_PATCH=`$(ECHO) $$i` $(MAKE) all \
            || exit 1; $(CD) ..; \
	    $(ECHO) "<<<Finished Recursively making Patcher for JRE "$$i" "$@" @ `$(DATE)`." ; \
	done
	$(ECHO) ">>>Recursively making "$$i" "$@" @ `$(DATE)` ..."; \
#Commenting this test out because it's proven to work for over 7 releases 
#without a flaw and it is starting to really add to the build time
#	$(MAKE) verify 

verify:
	$(RM) -r $(TEMP_DIR)/test
	$(MKDIR) $(TEMP_DIR)/test
	$(CP) -rf $(NEW_IMAGE_JRE_DIR)/ $(TEMP_DIR)/test/new
	$(RM) `$(FIND) $(TEMP_DIR)/test/new -name \*.map` dummy
	$(RM) `$(FIND) $(TEMP_DIR)/test/new -name \*.pdb` dummy
	@for i in `$(CD) $(ALT_BASE_IMAGE_DIR) ; $(LS) -d jre*` ; do \
	    $(CP) $(TEMP_DIR)/patcher/jre/obj/patcher-`echo $$i`.exe $(TEMP_DIR)/test/; \
	    $(CP) -rf $(ALT_BASE_IMAGE_DIR)/`echo $$i`  $(TEMP_DIR)/test; \
	    $(TEMP_DIR)/test/patcher-`echo $$i`.exe -s $(TEMP_DIR)/test/`echo $$i`; \
	    $(CD) $(TEMP_DIR)/test ; dircmp -s $(TEMP_DIR)/test/`echo $$i` $(TEMP_DIR)/test/new ; \
	done

#
# Sanity checks.
#
include $(INSTALL_BUILDDIR)/common/Sanity.gmk

clean: clobber

clobber::
	@for i in jre ; do \
	    $(ECHO) ">>>Recursively making "$$i" "clean" @ `$(DATE)` ..."; \
	    $(CD) $$i; $(MAKE) clean RELEASE="$(RELEASE)" FULL_VERSION="$(FULL_VERSION)" \
            || exit 1; $(CD) ..; \
	    $(ECHO) "<<<Finished Recursively making "$$i" all @ `$(DATE)`." ; \
	done


# this should be the last rule in this file:
all::
	@$(ECHO) $(ARCH) "Patcher Build finished:  " $(FULL_VERSION)
#
# Phonies to avoid accidents.
#
.PHONY: all build clean clobber jre


