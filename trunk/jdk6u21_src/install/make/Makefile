#
# Copyright (c) 2006, 2008, Oracle and/or its affiliates. All rights reserved.
# ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
#

#
# @(#)Makefile	1.53 10/03/23
#

#
# Makefile for building and packaging all of the JDK and the JRE. See
# also included files.
#
#
# Most frequently used targets:
#
#    all            -- stage the images, generate the patch, bind the 
#		       exe. 
#    patchgen       -- generate the patch
#    patcher	    -- build the patch installer
#    stage	    -- stages the jres that we want to patch, however, this 
#		       target activate only if ALT_BASE_IMAGE_JRE_ZIP and
#		       ALT_BASE_IMAGE_SDK_ZIP are defined, typically for 
#		       developer and special patches.
#    installer	    -- builds the installer for the platform
#    clobber        -- clobber the files generated by this Makefile 


INSTALL_BUILDDIR=.
include $(INSTALL_BUILDDIR)/common/Defs.gmk

all:: 
	@$(ECHO) $(ARCH) "Install Build started:  " $(FULL_VERSION)

# sigh. this is a real hack - JRE/JDK packaging and the Plugin
# require absolute paths - In order to get these, OUTPUTDIR must
# exist now. This forces the creation. This is done here so that
# it only happens once.
dummy := $(shell $(MKDIR) -p $(OUTPUTDIR))

# note the visualvm binaries need to be extracted into the images
# directory before the patcher starts, so that its packaged correctly  
# with the windows updates.
SUBDIRS = visualvm pack

ifeq ($(ARCH_DATA_MODEL),64)
  ifeq ($(PLATFORM), solaris)
    SUBDIRS = visualvm
  endif
 ifeq ($(PLATFORM)$(ARCH), windowsamd64)
   SUBDIRS += rebase update 
 endif
else
  ifeq ($(PLATFORM), windows)
    SUBDIRS += rebase sign update
  endif
endif

SUBDIRS += installer

ifndef EXTERNALSANITYCONTROL
all:: sanity
patchgen:: sanity
patcher:: sanity
installer:: sanity
endif

all build::
	@for i in $(SUBDIRS) ; do \
	    $(ECHO) ">>>Recursively making "$$i" "$@" @ `$(DATE)` ..."; \
	    $(CD) $$i; $(MAKE) \
            || exit 1; $(CD) ..; \
	    $(ECHO) "<<<Finished Recursively making "$$i" "$@" @ `$(DATE)`." ; \
	done

pack::
	$(CD) pack ; $(MAKE) all

visualvm::
	$(CD) visualvm ; $(MAKE) all

patchgen::
	$(CD) update/patchgen ; $(MAKE) all

patcher::
	$(CD) update/patcher ; $(MAKE) all

stage::
	$(CD) update/stage ; $(MAKE) all

installer::
	$(CD) installer ; $(MAKE) all	

cobundle::
	$(CD) installer/bundles/windows/ishield/wrapper/wrapper.jdk ; $(MAKE) -f Makefile.cobundle

plus:
	$(CD) installer/bundles/windows/ishield/jre; $(MAKE) generate_iftw
	$(CD) installer/bundles/windows/xmlinffile; $(MAKE) all

#This target will build the plus targets and will also rebuild the jre and jdk offine 
#ALT_AUMSI_DIR needs to be set to the latest au msi/cab file location
au_plus:
	$(CD) installer/bundles/windows/ishield/jre; $(MAKE) generate_iftw
	$(CP) $(OUTPUTDIR)/tmp/wrapper-jre-sponsor/obj/* $(OUTPUTDIR)/tmp/wrapper-jre/obj/
	$(CD) installer/bundles/windows/ishield/wrapper/wrapper.jre; $(MAKE) plus
	$(CD) installer/bundles/windows/ishield/wrapper/wrapper.jdk; $(MAKE) plus
	$(CD) installer/bundles/windows/xmlinffile; $(MAKE) all

#Also build MSI files
enhanced_plus:
#	$(CD) pack; $(MAKE) pack-jre #enhanced is for jre only
#	$(MAKE) patchgen
#	$(MAKE) patcher
	$(RM) $(OUTPUTDIR)/tmp/ishield/patch/*javaad*
	$(CD) installer/bundles/windows/ishield; $(MAKE) enhanced_plus 
	$(CD) installer/bundles/windows/xmlinffile; $(MAKE) all

jdk_plus:
	$(CD) installer/bundles/windows/ishield/wrapper/wrapper.jdk; $(MAKE) plus 

#
# Sanity checks.
#
include $(INSTALL_BUILDDIR)/common/Sanity.gmk

clean: clobber

clobber: install-clobber

install-clobber::
	@for i in $(SUBDIRS) ; do \
	    $(ECHO) ">>>Recursively making "$$i" "clean" @ `$(DATE)` ..."; \
	    $(CD) $$i; $(MAKE) clean RELEASE="$(RELEASE)" FULL_VERSION="$(FULL_VERSION)" \
            || exit 1; $(CD) ..; \
	    $(ECHO) "<<<Finished Recursively making "$$i" all @ `$(DATE)`." ; \
	done


# this should be the last rule in this file:
all::
	@$(ECHO) $(ARCH) "Install Build finished:  " $(FULL_VERSION)

#
# Phonies to avoid accidents.
#
.PHONY: all build clean clobber install-clobber sanity patchgen patcher stage installer visualvm pack
